name: Run Databricks Job via OAuth

on:
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œç”¨ãƒˆãƒªã‚¬ãƒ¼

jobs:
  run-dbx-job:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq  # â† å¿µã®ãŸã‚è¿½åŠ ï¼ˆãƒ©ãƒ³ãƒŠãƒ¼ã«å…¥ã£ã¦ãªã„å ´åˆãŒã‚ã‚‹ï¼‰
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get Databricks OAuth Token
        id: get_token
        run: |
          response=$(curl -s -X POST \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "grant_type=client_credentials" \
            -d "client_id=${{ secrets.DATABRICKS_CLIENT_ID }}" \
            -d "client_secret=${{ secrets.DATABRICKS_CLIENT_SECRET }}" \
            -d "scope=all" \   # ðŸ‘ˆ ã“ã‚Œé‡è¦ï¼Databricks OAuthã§ã¯ã‚¹ã‚³ãƒ¼ãƒ—æŒ‡å®šå¿…é ˆ
            ${{ secrets.DATABRICKS_TOKEN_URL }})
          
          echo "token=$(echo $response | jq -r .access_token)" >> $GITHUB_OUTPUT

      - name: Trigger Databricks Job
        run: |
          result=$(curl -s -X POST "${{ secrets.DATABRICKS_WORKSPACE_URL }}/api/2.1/jobs/run-now" \
            -H "Authorization: Bearer ${{ steps.get_token.outputs.token }}" \
            -H "Content-Type: application/json" \
            -d "{\"job_id\": ${{ secrets.DATABRICKS_JOB_ID }}}")
          echo "Response: $result"
